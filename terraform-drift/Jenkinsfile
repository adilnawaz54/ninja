pipeline {
    agent any

    tools {
        terraform 'tf 1.12'  // üëà Reference name from Jenkins Global Tool Config
    }

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/your-org/terraform-drift-demo.git', branch: 'main'
            }
        }

        stage('Terraform Init & Drift Detection') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'aws-access-key-id',
                            usernameVariable: 'ACCESS_KEY',
                            passwordVariable: 'SECRET_KEY'
                        )
                    ]) {
                        // Export credentials to environment
                        env.AWS_ACCESS_KEY_ID = "${ACCESS_KEY}"
                        env.AWS_SECRET_ACCESS_KEY = "${SECRET_KEY}"

                        // Terraform commands
                        def code = sh(script: '''
                            terraform -version
                            terraform init -input=false
                            terraform plan -detailed-exitcode
                        ''', returnStatus: true)

                        if (code == 0) {
                            echo "‚úÖ No drift detected."
                        } else if (code == 2) {
                            echo "‚ö†Ô∏è Drift detected!"
                            currentBuild.result = 'UNSTABLE'
                        } else {
                            error("‚ùå Terraform plan failed.")
                        }
                    }
                }
            }
        }
    }

    post {
        failure {
            echo "‚ùå Build failed."
        }
        unstable {
            echo "‚ö†Ô∏è Drift detected! Marking build as unstable."
        }
    }
}
